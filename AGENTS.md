# Migration Plan: Rust Codex CLI to .NET

## Completed Summary

- Bootstrapped the .NET CLI with configuration loading, interactive mode, history management, sandbox enforcement and patch replay.
- Ported provider management, API key handling and TUI widgets with approval workflow.
- Added MCP client/server support with SSE events and cross-language tests.
- Migrated utilities such as ExecCommandUtils, SafeCommand, ExecRunner/ExecEnv, OpenAiApiKey, OpenAiTools, Backoff, GitUtils and SignalUtils.
- Ported project documentation, user notifications, environment flags, model provider registry, config profile helpers, configuration types, conversation and message history, approval mode parsing, config overrides, elapsed time helpers and MCP tool call.
- Updated Rust and C# sources with status comments and added parity tests for each port.
- Implemented ChatCompletions aggregator and hooked it into ModelClient with new unit and integration tests.
- Fixed recursion bug in ResponseStream.Aggregate and verified aggregation tests pass.
- Ported Codex error enums and EnvVarError helper with new unit tests.
- Implemented CodexWrapper session initialization with unit and CLI parity tests.
- Ported protocol event types and serialization helpers with parity tests.
- Ported AppConfig loader and integrated CodexWrapper into CodexToolRunner.
- Implemented Codex spawn interface and added unit and CLI parity tests.
- Ported model client agent (RealCodexAgent) with streaming tests.
- Ported response and rollout models with RolloutRecorder and replay parity tests.
- Integrated CodexWrapper into ExecCommand for session startup parity.
- Ported safety check helpers and updated cross-CLI tests for interactive save.
- Integrated CodexWrapper into InteractiveApp for session startup parity.
- Integrated safety checks into ExecCommand using sandbox-aware policies and added SequenceEqualityComparer helper.
- Added Ctrl+C signal handling to ExecCommand via SignalUtils and verified cancellation with new tests.
- Fixed project paths in cross-language tests so MSBuild can locate the .NET projects.
- Fixed ExecEnv to ignore duplicate environment variables and removed default log level output to match Rust CLI.
- Added unit test covering duplicate environment variable handling in ExecEnv.
- Ported json_to_toml helper and added unit tests verifying TOML conversion.
- Ported ChatGptLogin helper and added unit test ensuring script deployment.
- Ported ExecPolicy loader and added unit tests verifying command filtering.
- Connected ChatGptLogin into LoginCommand with injectable delegate and added new unit test.
- Ported debug sandbox and proto commands with a new ProtoCommand unit test.
- Implemented MCP event streaming helpers (McpEventStream) and added watch-events tests.
- Ported `format_exec_output` helper as `Codex.FormatExecOutput` with new unit test.
- Ported `get_writable_roots` helper as `Codex.GetWritableRoots` with new unit test.
- Ported `get_last_assistant_message_from_turn` and `record_conversation_history` helpers as `Codex` methods with new unit tests.
- Ported `convert_apply_patch_to_protocol` helper as `Codex.ConvertApplyPatchToProtocol` with unit, integration and CLI tests.
- Ported `print_summary` helper as `PatchSummary.PrintSummary` with new unit and CLI tests.
- Ported `first_offending_path` helper as `Codex.FirstOffendingPath` with new unit tests.
- Ported `apply_changes_from_apply_patch` and `apply_changes_from_apply_patch_and_report` as `PatchApplier.ApplyAction` and `PatchApplier.ApplyActionAndReport` with new unit tests.
- Ported `apply_patch` helper as `PatchApplier.ApplyAndReport` with new unit, integration and CLI tests.
- Ported `is_write_patch_constrained_to_writable_paths` helper as `Safety.IsWritePatchConstrainedToWritableRoots` with new unit test.
- Ported `to_exec_params` and `parse_container_exec_arguments` helpers as `Codex.ToExecParams` and `Codex.TryParseContainerExecArguments` with new unit tests.
- Ported platform sandbox detection as `Safety.GetPlatformSandbox` with new unit test.
- Ported `State.partial_clone` helper as `CodexState.PartialClone` with new unit test.
- Ported `maybe_notify` helper as `Codex.MaybeNotify` with new unit test.
- Ported `notify_exec_command_begin`, `notify_exec_command_end`, and `notify_background_event` helpers as `Codex.NotifyExecCommandBegin`, `Codex.NotifyExecCommandEnd` and `Codex.NotifyBackgroundEvent` with new unit tests.
- Ported `inject_input` and `get_pending_input` helpers as `Codex.InjectInput` and `Codex.GetPendingInput` with new unit tests.
- Ported `resolve_path` helper as `Codex.ResolvePath` with new unit tests.
- Ported `set_task` and `remove_task` helpers as `Codex.SetTask` and `Codex.RemoveTask` with new unit tests.
- Ported `prompt.md` base instructions and `APPLY_PATCH_TOOL_INSTRUCTIONS` constant to C# with runtime loading.
- Marked prompt and apply_patch instruction markdown files with port comments for traceability.
- Ported `record_conversation_items` and `record_rollout_items` helpers as `Codex.RecordConversationItemsAsync` and `Codex.RecordRolloutItemsAsync` with new unit tests.
- Ported `request_command_approval`, `request_patch_approval`, `notify_approval` and `add_approved_command` helpers as `Codex` methods with new unit tests.
- Updated Prompt instruction loader to strip HTML comments so tests consume the same text as Rust.
- Ported `call_tool` helper as `Codex.CallToolAsync` with unit, integration and CLI parity tests.
- Ported `abort` helper as `Codex.Abort` with unit and CLI parity tests.
- Ported `send_event` helper as `Codex.SendEventAsync` with new unit tests.
- Added event notifications in `McpToolCall.HandleMcpToolCallAsync` with unit tests verifying begin/end events.
- Ported `history_metadata` and `lookup` helpers as `MessageHistory.HistoryMetadataAsync` and `MessageHistory.LookupEntry` with new unit tests.
- Ported `append_entry` helper as `MessageHistory.AppendEntryAsync` with file locking and permissions handling.
- Integrated `Codex.MaybeNotify` into RealCodexAgent and CLI loops with new parity tests.
- Ported MCP tool name helpers `fully_qualified_tool_name` and `try_parse_fully_qualified_tool_name` with unit tests verifying round-trip parsing.
- Integrated MessageHistory.HistoryMetadataAsync into HistoryCommand `messages-entry` for parity.
- Integrated Codex.CallToolAsync into ExecCommand remote workflow for parity.
- Integrated Codex.NotifyExecCommandBegin/End and NotifyBackgroundEvent into ExecCommand for denial diagnostics with new cross-CLI test.
- Integrated Codex.ResolvePath into ExecCommand path handling for logs and instructions.
- Integrated Codex.RecordConversationItemsAsync into ExecCommand event loop for session recording parity.
- Integrated Codex.Abort into ExecCommand and InteractiveApp lifecycle to clear session state on cancel.
- Added TaskStarted events to RealCodexAgent and wired Codex.SetTask/RemoveTask into CLI loops for parity.
- Integrated Codex.ConvertApplyPatchToProtocol into ExecCommand patch handling with new cross-CLI test.
- Integrated PatchSummary.PrintSummary into ExecCommand patch workflow.
- Added cross-CLI test validating DebugCommand seatbelt parity.
- Added cross-CLI test validating DebugCommand landlock parity.
- Added cross-CLI test validating ProtoCommand help parity.
- Added cross-CLI test validating LoginCommand help parity.

## Rust to C# Mapping

- codex-rs/tui/src/exec_command.rs -> codex-dotnet/CodexCli/Util/ExecCommandUtils.cs (done)
- codex-rs/core/src/is_safe_command.rs -> codex-dotnet/CodexCli/Util/SafeCommand.cs (done)
- codex-rs/core/src/exec.rs -> codex-dotnet/CodexCli/Util/ExecRunner.cs (done)
- codex-rs/core/src/exec_env.rs -> codex-dotnet/CodexCli/Util/ExecEnv.cs (done)
- codex-rs/core/src/openai_api_key.rs -> codex-dotnet/CodexCli/Util/OpenAiApiKey.cs (done)
- codex-rs/core/src/openai_tools.rs -> codex-dotnet/CodexCli/Util/OpenAiTools.cs (done)
- codex-rs/core/src/util.rs -> codex-dotnet/CodexCli/Util/{Backoff.cs,GitUtils.cs,SignalUtils.cs} (done)
- codex-rs/core/src/project_doc.rs -> codex-dotnet/CodexCli/Util/ProjectDoc.cs (done)
- codex-rs/core/src/user_notification.rs -> codex-dotnet/CodexCli/Util/UserNotification.cs (done)
- codex-rs/core/src/flags.rs -> codex-dotnet/CodexCli/Config/EnvFlags.cs (done)
- codex-rs/core/src/model_provider_info.rs -> codex-dotnet/CodexCli/Config/ModelProviderInfo.cs (done)
- codex-rs/core/src/config_profile.rs -> codex-dotnet/CodexCli/Config/ConfigProfile.cs (done)
- codex-rs/core/src/config_types.rs -> codex-dotnet/CodexCli/Config/{History.cs,ShellEnvironmentPolicy.cs,Tui.cs,UriBasedFileOpener.cs,ReasoningModels.cs} (done)
- codex-rs/core/src/config.rs -> codex-dotnet/CodexCli/Config/AppConfig.cs (done)
- codex-rs/core/src/client_common.rs -> codex-dotnet/CodexCli/{Models/{Prompt.cs,ResponseEvent.cs,ReasoningModels.cs},Util/{ReasoningUtils.cs,ModelClient.cs}} (done)
- codex-rs/core/src/conversation_history.rs -> codex-dotnet/CodexCli/Util/ConversationHistory.cs (done)
- codex-rs/core/src/message_history.rs -> codex-dotnet/CodexCli/Util/MessageHistory.cs (done)
- codex-rs/core/src/message_history.rs history_metadata -> codex-dotnet/CodexCli/Util/MessageHistory.cs HistoryMetadataAsync (done)
- codex-rs/core/src/message_history.rs lookup -> codex-dotnet/CodexCli/Util/MessageHistory.cs LookupEntry (done)
- codex-rs/core/src/message_history.rs append_entry -> codex-dotnet/CodexCli/Util/MessageHistory.cs AppendEntryAsync (done)
- codex-rs/common/src/approval_mode_cli_arg.rs -> codex-dotnet/CodexCli/Commands/ApprovalModeCliArg.cs (done)
- codex-rs/common/src/config_override.rs -> codex-dotnet/CodexCli/Config/ConfigOverrides.cs (done)
- codex-rs/common/src/elapsed.rs -> codex-dotnet/CodexCli/Util/Elapsed.cs (done)
- codex-rs/core/src/mcp_tool_call.rs -> codex-dotnet/CodexCli/Util/McpToolCall.cs (done)
- codex-rs/core/src/mcp_connection_manager.rs -> codex-dotnet/CodexCli/Util/McpConnectionManager.cs (done)
- codex-rs/core/src/mcp_connection_manager.rs fully_qualified_tool_name -> codex-dotnet/CodexCli/Util/McpConnectionManager.cs FullyQualifiedToolName (done)
- codex-rs/core/src/mcp_connection_manager.rs try_parse_fully_qualified_tool_name -> codex-dotnet/CodexCli/Util/McpConnectionManager.cs TryParseFullyQualifiedToolName (done)
- codex-rs/mcp-server/src/json_to_toml.rs -> codex-dotnet/CodexCli/Util/JsonToToml.cs (done)
- codex-rs/mcp-server/src/message_processor.rs -> codex-dotnet/CodexCli/Util/McpEventStream.cs (done)
- codex-rs/execpolicy/src/lib.rs -> codex-dotnet/CodexCli/Util/ExecPolicy.cs (done)
- codex-rs/core/src/chat_completions.rs -> codex-dotnet/CodexCli/Util/ChatCompletions.cs (done)
- codex-rs/core/src/error.rs -> codex-dotnet/CodexCli/Util/CodexErr.cs (done)
- codex-rs/login/src/lib.rs -> codex-dotnet/CodexCli/Util/ChatGptLogin.cs (done)
 - codex-rs/cli/src/login.rs -> codex-dotnet/CodexCli/Commands/LoginCommand.cs (done, help parity tested)
 - codex-rs/cli/src/debug_sandbox.rs -> codex-dotnet/CodexCli/Commands/DebugCommand.cs (done, seatbelt/landlock parity tested)
- codex-rs/cli/src/proto.rs -> codex-dotnet/CodexCli/Commands/ProtoCommand.cs (done, parity tested)
- codex-rs/core/src/safety.rs -> codex-dotnet/CodexCli/Util/Safety.cs (done)
- codex-rs/core/src/exec.rs SandboxType -> codex-dotnet/CodexCli/Protocol/SandboxType.cs (done)
- codex-rs/core/src/safety.rs get_platform_sandbox -> codex-dotnet/CodexCli/Util/Safety.cs GetPlatformSandbox (done)
- codex-rs/core/src/codex_wrapper.rs -> codex-dotnet/CodexCli/Util/CodexWrapper.cs (done)
- codex-rs/core/src/protocol.rs -> codex-dotnet/CodexCli/Protocol/Event.cs (done)
- codex-rs/core/prompt.md -> codex-dotnet/CodexCli/prompt.md (done)
- codex-rs/apply-patch/apply_patch_tool_instructions.md -> codex-dotnet/CodexCli/ApplyPatch/apply_patch_tool_instructions.md (done)
- codex-rs/apply-patch/src/lib.rs APPLY_PATCH_TOOL_INSTRUCTIONS -> codex-dotnet/CodexCli/Models/Prompt.cs ApplyPatchToolInstructions (done)
- codex-rs/core/src/client_common.rs BASE_INSTRUCTIONS -> codex-dotnet/CodexCli/Models/Prompt.cs BaseInstructions (done)
- codex-rs/core/src/codex.rs format_exec_output -> codex-dotnet/CodexCli/Util/Codex.cs FormatExecOutput (done)
- codex-rs/core/src/codex.rs get_writable_roots -> codex-dotnet/CodexCli/Util/Codex.cs GetWritableRoots (done)
- codex-rs/core/src/codex.rs get_last_assistant_message_from_turn -> codex-dotnet/CodexCli/Util/Codex.cs GetLastAssistantMessageFromTurn (done)
- codex-rs/core/src/codex.rs record_conversation_history -> codex-dotnet/CodexCli/Util/Codex.cs RecordConversationHistory (done)
- codex-rs/core/src/codex.rs convert_apply_patch_to_protocol -> codex-dotnet/CodexCli/Util/Codex.cs ConvertApplyPatchToProtocol (done)
- codex-rs/core/src/codex.rs first_offending_path -> codex-dotnet/CodexCli/Util/Codex.cs FirstOffendingPath (done)
- codex-rs/core/src/safety.rs is_write_patch_constrained_to_writable_paths -> codex-dotnet/CodexCli/Util/Safety.cs IsWritePatchConstrainedToWritableRoots (done)
- codex-rs/core/src/codex.rs to_exec_params -> codex-dotnet/CodexCli/Util/Codex.cs ToExecParams (done)
- codex-rs/core/src/codex.rs parse_container_exec_arguments -> codex-dotnet/CodexCli/Util/Codex.cs TryParseContainerExecArguments (done)
- codex-rs/core/src/codex.rs resolve_path -> codex-dotnet/CodexCli/Util/Codex.cs ResolvePath (done)
- codex-rs/apply-patch/src/lib.rs print_summary -> codex-dotnet/CodexCli/ApplyPatch/PatchSummary.cs PrintSummary (done)
- codex-rs/core/src/codex.rs apply_changes_from_apply_patch -> codex-dotnet/CodexCli/ApplyPatch/PatchApplier.cs ApplyAction (done)
- codex-rs/core/src/codex.rs apply_changes_from_apply_patch_and_report -> codex-dotnet/CodexCli/ApplyPatch/PatchApplier.cs ApplyActionAndReport (done)
- codex-rs/apply-patch/src/lib.rs apply_patch -> codex-dotnet/CodexCli/ApplyPatch/PatchApplier.cs ApplyAndReport (done)
- codex-rs/core/src/codex.rs State.partial_clone -> codex-dotnet/CodexCli/Util/CodexState.cs PartialClone (done)
- codex-rs/core/src/codex.rs maybe_notify -> codex-dotnet/CodexCli/Util/Codex.cs MaybeNotify (done)
- codex-rs/core/src/codex.rs notify_exec_command_begin -> codex-dotnet/CodexCli/Util/Codex.cs NotifyExecCommandBegin (done)
- codex-rs/core/src/codex.rs notify_exec_command_end -> codex-dotnet/CodexCli/Util/Codex.cs NotifyExecCommandEnd (done)
- codex-rs/core/src/codex.rs notify_background_event -> codex-dotnet/CodexCli/Util/Codex.cs NotifyBackgroundEvent (done)
- codex-rs/core/src/codex.rs inject_input -> codex-dotnet/CodexCli/Util/Codex.cs InjectInput (done)
- codex-rs/core/src/codex.rs get_pending_input -> codex-dotnet/CodexCli/Util/Codex.cs GetPendingInput (done)
- codex-rs/core/src/codex.rs set_task -> codex-dotnet/CodexCli/Util/Codex.cs SetTask (done)
- codex-rs/core/src/codex.rs remove_task -> codex-dotnet/CodexCli/Util/Codex.cs RemoveTask (done)
- codex-rs/core/src/codex.rs record_rollout_items -> codex-dotnet/CodexCli/Util/Codex.cs RecordRolloutItemsAsync (done)
- codex-rs/core/src/codex.rs record_conversation_items -> codex-dotnet/CodexCli/Util/Codex.cs RecordConversationItemsAsync (done)
- codex-rs/core/src/codex.rs request_command_approval -> codex-dotnet/CodexCli/Util/Codex.cs RequestCommandApproval (done)
- codex-rs/core/src/codex.rs request_patch_approval -> codex-dotnet/CodexCli/Util/Codex.cs RequestPatchApproval (done)
- codex-rs/core/src/codex.rs notify_approval -> codex-dotnet/CodexCli/Util/Codex.cs NotifyApproval (done)
- codex-rs/core/src/codex.rs add_approved_command -> codex-dotnet/CodexCli/Util/Codex.cs AddApprovedCommand (done)
- codex-rs/core/src/codex.rs call_tool -> codex-dotnet/CodexCli/Util/Codex.cs CallToolAsync (done)
- codex-rs/core/src/codex.rs abort -> codex-dotnet/CodexCli/Util/Codex.cs Abort (done)
- codex-rs/core/src/codex.rs send_event -> codex-dotnet/CodexCli/Util/Codex.cs SendEventAsync (done)
- codex-rs/core/src/codex.rs -> codex-dotnet/CodexCli/Util/Codex.cs (partial)
- codex-rs/exec/src/lib.rs -> codex-dotnet/CodexCli/Commands/ExecCommand.cs (partial, safety and Ctrl+C integrated)
- codex-rs/core/src/client.rs -> codex-dotnet/CodexCli/Protocol/RealCodexAgent.cs (done)
- codex-rs/core/src/models.rs -> codex-dotnet/CodexCli/Models/ResponseItem.cs (done)
- codex-rs/core/src/rollout.rs -> codex-dotnet/CodexCli/Util/RolloutRecorder.cs and Commands/ReplayCommand.cs (done)
- codex-rs/tui/src/lib.rs -> codex-dotnet/CodexCli/Interactive/InteractiveApp.cs (done)

## TODO

- Integrate newly ported utilities throughout CLI commands and finalize SSE handling.
- Expand CLI and cross-language parity tests and fix flakes, including chat aggregation.
- Resolve exec parity test failures by aligning provider configuration between implementations.
- Add sandbox enforcement logic and wire ApprovalModeCliArg and ExecEnv into command execution.
- Improve API key login flow using OpenAiApiKey helper and implement Ctrl+C handling via SignalUtils (partial: ExecCommand).
- Implement CLI comparitive tests ensuring .NET and Rust outputs match for chat aggregation.
- Add AppConfig loading parity tests and wire into remaining commands.
- Port remaining Codex session workflow (submission loop, rollout persistence) to .NET.
- Expand ResponseItem coverage with integration tests for new event types.
- Wire ProtoCommand into parity tests and CLI workflows (done).
- Wire DebugCommand into parity tests and CLI workflows (done).
- Wire LoginCommand into parity tests and CLI workflows (done).
- Integrate Codex.FormatExecOutput into ExecCommand parity tests.
- Integrate Codex.GetWritableRoots into spawn workflow.
- Integrate Codex.GetLastAssistantMessageFromTurn and RecordConversationHistory into conversation logic.
- Integrate Codex.ConvertApplyPatchToProtocol into ExecCommand patch handling. (done)
- Integrate Codex.ToExecParams and TryParseContainerExecArguments into ExecCommand function call handling.
 - Integrate PatchSummary.PrintSummary into patch application workflow. (done)
- Integrate PatchApplier.ApplyActionAndReport into CLI patch workflows.
- Integrate PatchApplier.ApplyAndReport into CLI patch workflows.
- Integrate Codex.MaybeNotify into session event notifications. (done)
 - Integrate Codex.NotifyExecCommandBegin, NotifyExecCommandEnd and NotifyBackgroundEvent into session event workflow. (done)
- Integrate Codex.InjectInput and GetPendingInput into session input workflow.
- Integrate Codex.ResolvePath into command path handling. (done)
- Integrate Codex.SetTask and Codex.RemoveTask into session task workflow. (done)
- Integrate Codex.RequestCommandApproval and RequestPatchApproval into approval workflow.
- Integrate Codex.NotifyApproval and AddApprovedCommand into approval workflow.
- Integrate Codex.CallToolAsync into CLI tool-call workflow.
- Integrate Codex.CallToolAsync into CLI tool-call workflow. (done)
- Integrate Codex.SendEventAsync into MCP tool call notifications. (done)
- Integrate Codex.Abort into session lifecycle management. (done)
- Integrate Codex.RecordConversationItemsAsync and RecordRolloutItemsAsync into session recording workflow. (done)
- Integrate Prompt base and apply_patch instructions loading into Prompt.GetFullInstructions.
- Integrate MessageHistory.HistoryMetadataAsync and LookupEntry into history CLI workflows. (done)
